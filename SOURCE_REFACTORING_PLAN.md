# ソースコードリファクタリング計画

## 概要
テストコードのリファクタリングが完了したため、次はソースコード本体のリファクタリングを計画します。
総ファイル数: 52ファイル（約6,295行）

## リファクタリング目標

### 1. コードの重複削減
- 共通処理の抽出とユーティリティ化
- エラーハンドリングの統一化
- レスポンス生成の共通化

### 2. 型安全性の向上
- any型の排除
- 厳密な型定義の適用
- Zodスキーマの活用強化

### 3. アーキテクチャの改善
- レイヤー分離の明確化
- 依存関係の整理
- テスタビリティの向上

## 優先度別リファクタリング対象

### 🔴 優先度高（大規模ファイル・複雑性高）

#### Durable Objects（3ファイル、1,236行）
1. **`src/durable-objects/vector-manager.ts`** (615行)
   - 問題点:
     - ファイルサイズが大きすぎる
     - 責務が多すぎる（ベクトル管理、ジョブ管理、統計管理）
     - エラーハンドリングの重複
   - 改善案:
     - ジョブ管理を別クラスに分離
     - 統計管理を別モジュールに分離
     - 共通エラーハンドラーの作成
     - メソッドの粒度を細かくする

2. **`src/durable-objects/notion-manager.ts`** (422行)
   - 問題点:
     - Notion APIとの結合度が高い
     - 同期ロジックが複雑
     - エラー処理の一貫性不足
   - 改善案:
     - Notion API通信層の分離
     - 同期ストラテジーパターンの適用
     - エラーリトライロジックの共通化

3. **`src/durable-objects/ai-embeddings.ts`** (199行)
   - 問題点:
     - ジョブ管理ロジックの重複
     - AIモデル設定のハードコーディング
   - 改善案:
     - ジョブ管理基底クラスの作成
     - モデル設定の外部化

#### Workflows（2ファイル、770行）
1. **`src/workflows/file-processing.ts`** (387行)
   - 問題点:
     - 処理フローが長すぎる
     - ファイルタイプ別処理の分岐が複雑
     - チャンク処理の重複
   - 改善案:
     - ファイルタイプ別ハンドラーの作成
     - チャンク処理の共通化
     - ステップごとの処理を別メソッドに分離

2. **`src/workflows/notion-sync.ts`** (383行)
   - 問題点:
     - 同期ロジックが複雑
     - プロパティ処理の重複
     - エラーリカバリーが不十分
   - 改善案:
     - プロパティハンドラーの抽象化
     - 同期ステートマシンの導入
     - リトライメカニズムの強化

### 🟡 優先度中（中規模・改善余地あり）

#### Routes（約20ファイル、2,000行）

1. **共通課題**
   - エラーレスポンスの生成が各ファイルで重複
   - 認証チェックの重複
   - リクエスト検証の重複

2. **改善案**
   - エラーハンドラーミドルウェアの作成
   - 認証ミドルウェアの統一
   - バリデーションミドルウェアの作成
   - レスポンスビルダーの共通化

3. **特に改善が必要なファイル**
   - `src/routes/api/files/upload.ts` (250行) - ファイル処理の分離
   - `src/routes/api/notion/list-pages.ts` (193行) - ページング処理の共通化
   - `src/routes/api/vectors/status.ts` (160行) - ステータス管理の統一

### 🟢 優先度低（小規模・現状維持可能）

#### Schemas（5ファイル、約400行）
- 現状で十分に整理されている
- Zodスキーマは適切に定義されている
- 必要に応じて微調整のみ

#### Database（2ファイル、約100行）
- シンプルで明確な構造
- 大きな変更は不要

## リファクタリング実施計画

### Phase 1: 共通基盤の構築（1週間）
1. **共通ユーティリティの作成**
   ```typescript
   src/utils/
   ├── error-handler.ts     # 統一エラーハンドリング
   ├── response-builder.ts  # レスポンス生成ヘルパー
   ├── validation.ts        # 共通バリデーション
   └── retry.ts            # リトライロジック
   ```

2. **ミドルウェアの作成**
   ```typescript
   src/middleware/
   ├── auth.ts             # 認証ミドルウェア
   ├── error.ts            # エラーハンドリングミドルウェア
   ├── validation.ts       # バリデーションミドルウェア
   └── logging.ts          # ロギングミドルウェア
   ```

3. **基底クラスの作成**
   ```typescript
   src/base/
   ├── durable-object.ts   # Durable Object基底クラス
   ├── workflow.ts         # Workflow基底クラス
   └── job-manager.ts      # ジョブ管理基底クラス
   ```

### Phase 2: Durable Objectsのリファクタリング（1週間）
1. vector-manager.tsの分割
   - VectorManager（コア機能）
   - VectorJobManager（ジョブ管理）
   - VectorStatistics（統計管理）

2. notion-manager.tsの改善
   - NotionAPIClient（API通信）
   - NotionSyncManager（同期管理）
   - NotionDataMapper（データ変換）

3. ai-embeddings.tsの改善
   - 基底クラスの継承
   - モデル設定の外部化

### Phase 3: Workflowsのリファクタリング（1週間）
1. file-processing.tsの分割
   - FileAnalyzer（ファイル解析）
   - ChunkProcessor（チャンク処理）
   - VectorGenerator（ベクトル生成）

2. notion-sync.tsの改善
   - PropertyHandlers（プロパティ処理）
   - SyncStateMachine（同期状態管理）
   - ErrorRecovery（エラーリカバリー）

### Phase 4: Routesのリファクタリング（1週間）
1. 共通処理の抽出
2. ミドルウェアの適用
3. ファイルごとの責務の明確化

### Phase 5: テストと最適化（3日）
1. リファクタリング後のテスト実行
2. パフォーマンステスト
3. 最終調整

## 成功指標

### 定量的指標
- [ ] 最大ファイルサイズを300行以下に削減
- [ ] コード重複率を20%以下に削減
- [ ] any型の使用を0にする
- [ ] テストカバレッジ100%維持
- [ ] ビルド時間の改善（現状比10%以上）

### 定性的指標
- [ ] コードの可読性向上
- [ ] 保守性の向上
- [ ] 新機能追加の容易さ
- [ ] エラーハンドリングの一貫性
- [ ] チーム開発での理解しやすさ

## リスクと対策

### リスク
1. **既存機能の破壊**
   - 対策: 段階的リファクタリング、テスト駆動

2. **パフォーマンス劣化**
   - 対策: ベンチマークテストの実施

3. **互換性の喪失**
   - 対策: APIバージョニング、段階的移行

## 実装順序の推奨

1. **Week 1**: 共通基盤の構築
   - エラーハンドラー、レスポンスビルダー
   - ミドルウェアの作成
   - 基底クラスの設計

2. **Week 2**: vector-manager.tsのリファクタリング
   - 最も大きく複雑なファイルから着手
   - ジョブ管理と統計管理の分離

3. **Week 3**: Workflowsのリファクタリング
   - file-processing.tsの分割
   - notion-sync.tsの改善

4. **Week 4**: Routesの統一化
   - 共通処理の適用
   - ミドルウェアの導入

## 次のステップ

1. この計画のレビューと承認
2. Phase 1の詳細設計
3. ブランチ戦略の決定
4. リファクタリングの開始

---

作成日: 2024-08-30
作成者: Claude Code Assistant