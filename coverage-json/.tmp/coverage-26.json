{"c:/Users/mtama/node/vector-db/src/schemas/error.schema.ts":{"path":"c:/Users/mtama/node/vector-db/src/schemas/error.schema.ts","statementMap":{"0":{"start":{"line":2,"column":35},"end":{"line":15,"column":2}}},"fnMap":{},"branchMap":{},"s":{"0":1},"f":{},"b":{},"inputSourceMap":{"version":3,"sources":["C:/Users/mtama/node/vector-db/src/schemas/error.schema.ts"],"sourcesContent":["import { z } from '@hono/zod-openapi'\n\nexport const ErrorResponseSchema = z.object({\n  success: z.literal(false),\n  error: z.string().openapi({\n    example: 'Bad Request',\n    description: 'エラーの種類'\n  }),\n  message: z.string().openapi({\n    example: '無効なリクエストパラメータです',\n    description: 'エラーの詳細メッセージ'\n  }),\n  details: z.any().optional().openapi({\n    description: 'エラーの詳細情報'\n  })\n})\n\nexport type ErrorResponse = z.infer<typeof ErrorResponseSchema>"],"mappings":"AAAA,SAAS,SAAS;AAEX,aAAM,sBAAsB,EAAE,OAAO;AAAA,EAC1C,SAAS,EAAE,QAAQ,KAAK;AAAA,EACxB,OAAO,EAAE,OAAO,EAAE,QAAQ;AAAA,IACxB,SAAS;AAAA,IACT,aAAa;AAAA,EACf,CAAC;AAAA,EACD,SAAS,EAAE,OAAO,EAAE,QAAQ;AAAA,IAC1B,SAAS;AAAA,IACT,aAAa;AAAA,EACf,CAAC;AAAA,EACD,SAAS,EAAE,IAAI,EAAE,SAAS,EAAE,QAAQ;AAAA,IAClC,aAAa;AAAA,EACf,CAAC;AACH,CAAC;","names":[]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"d6a63d60aa5985710aa1a5dd58befc74fd0f881d"},"c:/Users/mtama/node/vector-db/src/schemas/embedding.schema.ts":{"path":"c:/Users/mtama/node/vector-db/src/schemas/embedding.schema.ts","statementMap":{"0":{"start":{"line":2,"column":39},"end":{"line":11,"column":2}},"1":{"start":{"line":12,"column":47},"end":{"line":20,"column":2}},"2":{"start":{"line":21,"column":36},"end":{"line":29,"column":2}},"3":{"start":{"line":30,"column":44},"end":{"line":39,"column":2}},"4":{"start":{"line":40,"column":44},"end":{"line":42,"column":2}},"5":{"start":{"line":43,"column":43},"end":{"line":52,"column":2}},"6":{"start":{"line":53,"column":31},"end":{"line":59,"column":2}},"7":{"start":{"line":60,"column":40},"end":{"line":63,"column":2}}},"fnMap":{},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1},"f":{},"b":{},"inputSourceMap":{"version":3,"sources":["C:/Users/mtama/node/vector-db/src/schemas/embedding.schema.ts"],"sourcesContent":["import { z } from '@hono/zod-openapi'\n\n// 埋め込み生成スキーマ\nexport const GenerateEmbeddingSchema = z.object({\n  text: z.string().min(1).openapi({\n    example: 'This is a sample text to generate embeddings',\n    description: '埋め込みを生成するテキスト'\n  }),\n  model: z.string().optional().openapi({\n    example: '@cf/baai/bge-base-en-v1.5',\n    description: '使用するモデル名'\n  })\n})\n\nexport const GenerateEmbeddingResponseSchema = z.object({\n  success: z.boolean(),\n  data: z.object({\n    jobId: z.string(),\n    workflowId: z.string(),\n    status: z.string()\n  }),\n  message: z.string()\n})\n\n// バッチ埋め込み生成スキーマ\nexport const BatchEmbeddingSchema = z.object({\n  texts: z.array(z.string()).min(1).openapi({\n    example: ['Text 1', 'Text 2', 'Text 3'],\n    description: '埋め込みを生成するテキストの配列'\n  }),\n  model: z.string().optional(),\n  batchSize: z.number().int().min(1).max(100).optional(),\n  saveToVectorize: z.boolean().optional()\n})\n\nexport const BatchEmbeddingResponseSchema = z.object({\n  success: z.boolean(),\n  data: z.object({\n    jobId: z.string(),\n    workflowId: z.string(),\n    status: z.string(),\n    textsCount: z.number()\n  }),\n  message: z.string()\n})\n\n// スケジュールバッチ埋め込みスキーマ\nexport const ScheduleBatchEmbeddingSchema = BatchEmbeddingSchema.extend({\n  delayMs: z.number().int().min(0).optional()\n})\n\nexport const ScheduleBatchResponseSchema = z.object({\n  success: z.boolean(),\n  data: z.object({\n    jobId: z.string(),\n    workflowId: z.string().optional(),\n    status: z.string(),\n    textsCount: z.number()\n  }),\n  message: z.string()\n})\n\n// モデル情報スキーマ\nexport const ModelInfoSchema = z.object({\n  name: z.string(),\n  description: z.string(),\n  dimensions: z.number(),\n  maxTokens: z.number(),\n  recommended: z.boolean()\n})\n\nexport const ListModelsResponseSchema = z.object({\n  success: z.boolean(),\n  data: z.array(ModelInfoSchema)\n})\n\n// 型定義のエクスポート\nexport type GenerateEmbedding = z.infer<typeof GenerateEmbeddingSchema>\nexport type GenerateEmbeddingResponse = z.infer<typeof GenerateEmbeddingResponseSchema>\nexport type BatchEmbedding = z.infer<typeof BatchEmbeddingSchema>\nexport type BatchEmbeddingResponse = z.infer<typeof BatchEmbeddingResponseSchema>\nexport type ScheduleBatchEmbedding = z.infer<typeof ScheduleBatchEmbeddingSchema>\nexport type ScheduleBatchResponse = z.infer<typeof ScheduleBatchResponseSchema>\nexport type ModelInfo = z.infer<typeof ModelInfoSchema>\nexport type ListModelsResponse = z.infer<typeof ListModelsResponseSchema>"],"mappings":"AAAA,SAAS,SAAS;AAGX,aAAM,0BAA0B,EAAE,OAAO;AAAA,EAC9C,MAAM,EAAE,OAAO,EAAE,IAAI,CAAC,EAAE,QAAQ;AAAA,IAC9B,SAAS;AAAA,IACT,aAAa;AAAA,EACf,CAAC;AAAA,EACD,OAAO,EAAE,OAAO,EAAE,SAAS,EAAE,QAAQ;AAAA,IACnC,SAAS;AAAA,IACT,aAAa;AAAA,EACf,CAAC;AACH,CAAC;AAEM,aAAM,kCAAkC,EAAE,OAAO;AAAA,EACtD,SAAS,EAAE,QAAQ;AAAA,EACnB,MAAM,EAAE,OAAO;AAAA,IACb,OAAO,EAAE,OAAO;AAAA,IAChB,YAAY,EAAE,OAAO;AAAA,IACrB,QAAQ,EAAE,OAAO;AAAA,EACnB,CAAC;AAAA,EACD,SAAS,EAAE,OAAO;AACpB,CAAC;AAGM,aAAM,uBAAuB,EAAE,OAAO;AAAA,EAC3C,OAAO,EAAE,MAAM,EAAE,OAAO,CAAC,EAAE,IAAI,CAAC,EAAE,QAAQ;AAAA,IACxC,SAAS,CAAC,UAAU,UAAU,QAAQ;AAAA,IACtC,aAAa;AAAA,EACf,CAAC;AAAA,EACD,OAAO,EAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,WAAW,EAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACrD,iBAAiB,EAAE,QAAQ,EAAE,SAAS;AACxC,CAAC;AAEM,aAAM,+BAA+B,EAAE,OAAO;AAAA,EACnD,SAAS,EAAE,QAAQ;AAAA,EACnB,MAAM,EAAE,OAAO;AAAA,IACb,OAAO,EAAE,OAAO;AAAA,IAChB,YAAY,EAAE,OAAO;AAAA,IACrB,QAAQ,EAAE,OAAO;AAAA,IACjB,YAAY,EAAE,OAAO;AAAA,EACvB,CAAC;AAAA,EACD,SAAS,EAAE,OAAO;AACpB,CAAC;AAGM,aAAM,+BAA+B,qBAAqB,OAAO;AAAA,EACtE,SAAS,EAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,SAAS;AAC5C,CAAC;AAEM,aAAM,8BAA8B,EAAE,OAAO;AAAA,EAClD,SAAS,EAAE,QAAQ;AAAA,EACnB,MAAM,EAAE,OAAO;AAAA,IACb,OAAO,EAAE,OAAO;AAAA,IAChB,YAAY,EAAE,OAAO,EAAE,SAAS;AAAA,IAChC,QAAQ,EAAE,OAAO;AAAA,IACjB,YAAY,EAAE,OAAO;AAAA,EACvB,CAAC;AAAA,EACD,SAAS,EAAE,OAAO;AACpB,CAAC;AAGM,aAAM,kBAAkB,EAAE,OAAO;AAAA,EACtC,MAAM,EAAE,OAAO;AAAA,EACf,aAAa,EAAE,OAAO;AAAA,EACtB,YAAY,EAAE,OAAO;AAAA,EACrB,WAAW,EAAE,OAAO;AAAA,EACpB,aAAa,EAAE,QAAQ;AACzB,CAAC;AAEM,aAAM,2BAA2B,EAAE,OAAO;AAAA,EAC/C,SAAS,EAAE,QAAQ;AAAA,EACnB,MAAM,EAAE,MAAM,eAAe;AAC/B,CAAC;","names":[]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"286b2567c213386e5f4a34b368118ca0a79a91a0"},"c:/Users/mtama/node/vector-db/src/routes/api/embeddings/batch.ts":{"path":"c:/Users/mtama/node/vector-db/src/routes/api/embeddings/batch.ts","statementMap":{"0":{"start":{"line":7,"column":35},"end":{"line":48,"column":2}},"1":{"start":{"line":49,"column":37},"end":{"line":75,"column":1}},"2":{"start":{"line":50,"column":2},"end":{"line":74,"column":3}},"3":{"start":{"line":51,"column":17},"end":{"line":51,"column":36}},"4":{"start":{"line":52,"column":27},"end":{"line":52,"column":68}},"5":{"start":{"line":53,"column":25},"end":{"line":53,"column":64}},"6":{"start":{"line":54,"column":19},"end":{"line":61,"column":5}},"7":{"start":{"line":62,"column":4},"end":{"line":66,"column":12}},"8":{"start":{"line":68,"column":4},"end":{"line":68,"column":62}},"9":{"start":{"line":69,"column":4},"end":{"line":73,"column":12}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":49,"column":37},"end":{"line":49,"column":38}},"loc":{"start":{"line":49,"column":50},"end":{"line":75,"column":1}},"line":49}},"branchMap":{"0":{"loc":{"start":{"line":72,"column":15},"end":{"line":72,"column":79}},"type":"cond-expr","locations":[{"start":{"line":72,"column":40},"end":{"line":72,"column":53}},{"start":{"line":72,"column":56},"end":{"line":72,"column":79}}],"line":72}},"s":{"0":1,"1":1,"2":4,"3":4,"4":4,"5":4,"6":4,"7":2,"8":2,"9":2},"f":{"0":4},"b":{"0":[1,1]},"inputSourceMap":{"version":3,"sources":["C:/Users/mtama/node/vector-db/src/routes/api/embeddings/batch.ts"],"sourcesContent":["import { createRoute, RouteHandler } from '@hono/zod-openapi'\nimport { ErrorResponseSchema, type ErrorResponse } from '../../../schemas/error.schema'\nimport {\n  BatchEmbeddingSchema,\n  BatchEmbeddingResponseSchema\n} from '../../../schemas/embedding.schema'\n\n// 環境の型定義\ntype EnvType = {\n  Bindings: Env\n}\n\n// バッチ埋め込み生成ルート\nexport const batchEmbeddingRoute = createRoute({\n  method: 'post',\n  path: '/embeddings/batch',\n  request: {\n    body: {\n      content: {\n        'application/json': {\n          schema: BatchEmbeddingSchema\n        }\n      }\n    }\n  },\n  responses: {\n    200: {\n      content: {\n        'application/json': {\n          schema: BatchEmbeddingResponseSchema\n        }\n      },\n      description: 'バッチ処理が開始されました'\n    },\n    400: {\n      content: {\n        'application/json': {\n          schema: ErrorResponseSchema\n        }\n      },\n      description: '不正なリクエスト'\n    },\n    500: {\n      content: {\n        'application/json': {\n          schema: ErrorResponseSchema\n        }\n      },\n      description: 'サーバーエラー'\n    }\n  },\n  tags: ['Embeddings'],\n  summary: 'バッチテキスト埋め込み生成',\n  description: '複数のテキストの埋め込みベクトルを非同期で一括生成します。処理状況はWorkflow IDで確認できます。'\n})\n\n// バッチ埋め込み生成ハンドラー\nexport const batchEmbeddingHandler: RouteHandler<typeof batchEmbeddingRoute, EnvType> = async (c) => {\n  try {\n    const body = c.req.valid('json')\n    \n    // Durable Objectを使用\n    const aiEmbeddingsId = c.env.AI_EMBEDDINGS.idFromName('default')\n    const aiEmbeddings = c.env.AI_EMBEDDINGS.get(aiEmbeddingsId)\n    \n    const result = await aiEmbeddings.generateBatchEmbeddings(\n      body.texts,\n      body.model,\n      {\n        batchSize: body.batchSize,\n        saveToVectorize: body.saveToVectorize\n      }\n    )\n    \n    return c.json({\n      success: true,\n      data: result,\n      message: `${result.textsCount}件のテキストの処理を開始しました`\n    }, 200)\n  } catch (error) {\n    console.error('Batch embedding generation error:', error)\n    return c.json<ErrorResponse, 500>({\n      success: false,\n      error: 'Internal Server Error',\n      message: error instanceof Error ? error.message : 'バッチ埋め込み生成中にエラーが発生しました'\n    }, 500)\n  }\n}"],"mappings":"AAAA,SAAS,mBAAiC;AAC1C,SAAS,2BAA+C;AACxD;AAAA,EACE;AAAA,EACA;AAAA,OACK;AAQA,aAAM,sBAAsB,YAAY;AAAA,EAC7C,QAAQ;AAAA,EACR,MAAM;AAAA,EACN,SAAS;AAAA,IACP,MAAM;AAAA,MACJ,SAAS;AAAA,QACP,oBAAoB;AAAA,UAClB,QAAQ;AAAA,QACV;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAAA,EACA,WAAW;AAAA,IACT,KAAK;AAAA,MACH,SAAS;AAAA,QACP,oBAAoB;AAAA,UAClB,QAAQ;AAAA,QACV;AAAA,MACF;AAAA,MACA,aAAa;AAAA,IACf;AAAA,IACA,KAAK;AAAA,MACH,SAAS;AAAA,QACP,oBAAoB;AAAA,UAClB,QAAQ;AAAA,QACV;AAAA,MACF;AAAA,MACA,aAAa;AAAA,IACf;AAAA,IACA,KAAK;AAAA,MACH,SAAS;AAAA,QACP,oBAAoB;AAAA,UAClB,QAAQ;AAAA,QACV;AAAA,MACF;AAAA,MACA,aAAa;AAAA,IACf;AAAA,EACF;AAAA,EACA,MAAM,CAAC,YAAY;AAAA,EACnB,SAAS;AAAA,EACT,aAAa;AACf,CAAC;AAGM,aAAM,wBAA2E,OAAO,MAAM;AACnG,MAAI;AACF,UAAM,OAAO,EAAE,IAAI,MAAM,MAAM;AAG/B,UAAM,iBAAiB,EAAE,IAAI,cAAc,WAAW,SAAS;AAC/D,UAAM,eAAe,EAAE,IAAI,cAAc,IAAI,cAAc;AAE3D,UAAM,SAAS,MAAM,aAAa;AAAA,MAChC,KAAK;AAAA,MACL,KAAK;AAAA,MACL;AAAA,QACE,WAAW,KAAK;AAAA,QAChB,iBAAiB,KAAK;AAAA,MACxB;AAAA,IACF;AAEA,WAAO,EAAE,KAAK;AAAA,MACZ,SAAS;AAAA,MACT,MAAM;AAAA,MACN,SAAS,GAAG,OAAO,UAAU;AAAA,IAC/B,GAAG,GAAG;AAAA,EACR,SAAS,OAAO;AACd,YAAQ,MAAM,qCAAqC,KAAK;AACxD,WAAO,EAAE,KAAyB;AAAA,MAChC,SAAS;AAAA,MACT,OAAO;AAAA,MACP,SAAS,iBAAiB,QAAQ,MAAM,UAAU;AAAA,IACpD,GAAG,GAAG;AAAA,EACR;AACF;","names":[]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"bf10cdd4a17440fdb0d53dc8372f667fe5b9b40d"}}